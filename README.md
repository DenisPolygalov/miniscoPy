<img src="https://avatars2.githubusercontent.com/u/26169608?s=400&u=c95268d6ce14e5fa4e4c94ec51888042c2245c66&v=4" width="150" align="right">

miniscoPy
=====


A package to analyse calcium imaging data recorded with the __[Miniscope](http://miniscope.org)__. 

* miniscoPy is a Python 3 implementation of CNMF-E, an efficient algorithm to deconvolve calcium transients ([Zhou et al, 2016](https://pdfs.semanticscholar.org/0c68/5753c9379f71b5120fe3b51589458c4de695.pdf)).
* It has been written based on the [CaImAn package](https://github.com/flatironinstitute/CaImAn). The CaImAn package is a versatile tool that can do several things (two photons, one photons, online analysis, etc). Here, the main idea is to have a simple package for straightforward analysis of Miniscope data with CNMF-E.
* __What does it do?__
	* Loads Miniscope AVI files
	* Creates one HDF5 file that includes everything
	* Runs the motion correction algorithm
	* Runs CNMF-E. That's it.
* __What it does not do?__
	* Loads all the available movie format on the Planet.
	* Creates memory map.
	* Analyses two-photon imaging 
	* Other methods such as PCA/ICA, etc.

Yet, the architecture of this package is almost the same as the CaImAn package. If needed, it is thus very easy to insert CaImAn functions. Besides, the visualization tools of miniscoPy have been kept at its bare minimum purposefully.

### Overview

To take a glimpse at the package, you can look at two Jupyter notebooks :
* __[main_cnmfe_e.ipynb](https://github.com/peyrachelab/miniscoPy/main_cnmf_e.py)__ for a minimal working example with actual data.
* __[main_test_hd_generated.ipynb](https://github.com/peyrachelab/miniscoPy/main_test_hd_generated.ipynb)__ for an example with simulated data of the head-direction system (requires [BRIAN2](https://brian2.readthedocs.io/en/stable/) and [XGBoost](http://xgboost.readthedocs.io/en/latest/python/python_intro.html))

## Getting Started

### Prerequisites

To install miniscoPy, several python packages are required. They are listed in [requirements.txt](https://github.com/peyrachelab/miniscoPY/requirements.txt) . The package pyav that loads the avi files generated by the Miniscope recording software is sometimes a bit complicated to install. The easiest way is probably to install it within a Conda environnment. At any rate, all the packages can be installed at once with pip3 by typing the following command line:

The most troublesome to install will probably be __[pyav](https://mikeboers.github.io/PyAV/)__. This package allows the fast loading of the avi files generated by the miniscope recording tool. The easiest way is probably to install it within a conda environnment. All the package can be installed at once with pip3.

```
git clone https://github.com/peyrachelab/miniscoPy
cd miniscoPy
pip3 install -r requirements.txt
```

MiniscoPy relies on several external packages, but everything can be installed at once with pip3 by typing the following command line:

If you want to install the package manually, the file requirement.txt lists the packages that must be installed first. Note that the package pyav, that loads  the avi files generated by the Miniscope recording software very fast, is sometimes a bit complicated to install.

### Installing

```
python setup.py install
python setup.py build_ext -i
```


## Deployment

CNMF-E has a lot of free parameters and two recording sessions from the same animal may be best analyzed with slightly different parameters. Thus, to keep track of the parameter set for each session, miniscoPy looks for a parameter file in the recording folder in __[yaml text format](http://yaml.org/start.html)__. An example of such file can be found in _[miniscoPy/example_movies/parameters.yaml](parameters.yaml)_.

The yaml file is loaded as a dictionary at the beginning of an analysis in a Python session:
```python
import yaml
parameters = yaml.load(open('/example_movies/parameters.yaml', 'r'))
```
The [Miniscope recording software](https://github.com/daharoni/Miniscope_DAQ_Software) saves several avi files in the recording folder. Before starting the analysis pipeline, it is required to list all the avi files in a recording folder:
```python
import glob
files = glob.glob('/example_movies/*.avi')
```
Then, the first step is the motion correction algorithm :
```python
from miniscopy.base.motion_correction import *
data, video_info = normcorre(files, None, parameters['motion_correction'])
```
The second step is CNMF-E :
```python
from miniscopy import CNMFE
cnm = CNMFE(data, parameters['cnmfe'])
cnm.fit()
```
Et voila!

A minimal working example can be found in [main_cnmf_e.py](main_cnmf_e.py). Another example with generated data can be found in [main_test_hd_generated.py](main_test_hd_generated.py).

## Built With

* [numpy](https://numpy.org) and [scipy](https://scipy.org)
* [pandas](https://pandas.pydata.org/) - Python Data Analysis Library
* [OpenCv](https://opencv.org/) - Open Source Computer Vision Library
* [h5py](https://www.h5py.org/) - Pythonic interface to the HDF5 binary data format
* [av](https://github.com/mikeboers/PyAV) - Pythonic binding for FFmpeg or Libav
* [scikit-learn](http://scikit-learn.org/stable/) - Machine learning in Python
* [tqdm](https://github.com/noamraph/tqdm)

Besides, codes from several toolboxes are used : 
* [CaImAn](https://github.com/flatironinstitute/CaImAn)
* [SIMA](http://www.losonczylab.org/sima/1.3.2/)
* [pyfluo](https://github.com/bensondaled/pyfluo)

## Version

* Future development
  * Integration of the great [neuroseries](https://github.com/MemDynLab/neuroseries)
  * Frame-by-frame dynamic visualization
* 0.0.1 (Current)
  * Work in progress

## Troubleshooting

Send me an email.

## Author

* Guillaume Viejo - *Initial work*

## License

This project is licensed under the GNU License - see the [LICENSE.md](LICENSE.md) file for details.

## Acknowledgments

* Hat tip to all the contributors of the different packages used here. Would not have been possible from scratch!
* Guillaume Etter from Sylvain Williams's lab for the miniscope calcium imaging movie example.





